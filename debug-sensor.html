<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DEBUG - Sensor Simulator Realtime</title>
  <link rel="stylesheet" href="/frontend/css/style.css">
  <style>
    /* Debug-specific styles */
    .debug-container { overflow-y: auto; height: calc(100vh - 75px); }
    
    .debug-panel {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      border: 1px solid #e2e8f0;
    }
    
    .debug-panel h3 {
      font-size: 18px;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 16px;
    }
    
    .log-container {
      max-height: 400px;
      overflow-y: auto;
      padding: 16px;
      background: #f8fafc;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }
    
    .log-entry {
      padding: 10px 14px;
      margin-bottom: 8px;
      background: white;
      border-radius: 6px;
      font-size: 13px;
      border-left: 3px solid #cbd5e1;
      font-family: 'Consolas', 'Monaco', monospace;
      line-height: 1.5;
    }
    
    .log-entry.info {
      border-left-color: #3b82f6;
    }
    
    .log-entry.success {
      border-left-color: #10b981;
    }
    
    .log-entry.error {
      border-left-color: #ef4444;
    }
    
    .log-time {
      color: #64748b;
      margin-right: 8px;
      font-size: 12px;
    }
    
    .log-sensor {
      color: #f59e0b;
      font-weight: 600;
      margin-right: 8px;
    }
    
    .log-value {
      color: #10b981;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="logo-space">
      <div class="logos">
        <div class="logo-slot">DEBUG MODE</div>
      </div>
    </div>
    <div class="title">SENSOR SIMULATOR - REALTIME</div>
  </header>

  <div class="debug-container">
  <div class="debug-container">
    <main class="container" style="display: block; height: auto; overflow-y: auto; padding: 24px;">
      
      <!-- Debug Control Panel -->
      <aside class="admin-panel" style="max-width: 100%; margin-bottom: 24px;">
        <h3 style="margin-bottom:12px;font-size:16px;font-weight:600;color:#1e293b;">Info Peserta</h3>
        <label>Nama:<input id="infoName" type="text" value="John Doe" placeholder="Nama peserta"></label>
        <label>Umur:<input id="infoAge" type="number" value="25" placeholder="Umur"></label>
        <label>Nomor Telepon:<input id="infoPhone" type="text" value="08123456789" placeholder="Nomor telepon"></label>
        <div class="buttons" style="margin-top:16px;">
          <button id="startBtn" type="button">Start Debug</button>
          <button id="stopBtn" type="button" disabled style="background:#ef4444;">Stop</button>
          <button id="resetBtn" type="button" style="background:#6366f1;">Reset</button>
        </div>
      </aside>

      <!-- Display Grid -->
      <section class="display" style="margin-bottom: 24px;">
        <div class="grid">
          <div class="card"><div class="label">Nama</div><div id="disp_name" class="value">-</div></div>
          <div class="card"><div class="label">Umur</div><div id="disp_age" class="value">-</div></div>
          <div class="card"><div class="label">No. Telp</div><div id="disp_phone" class="value">-</div></div>

          <div class="card big"><div class="label">Tinggi Badan</div><div id="disp_height" class="value bigv">- cm</div></div>
          <div class="card big"><div class="label">Sit and Reach</div><div id="disp_sit_and_reach" class="value bigv">- cm</div></div>
          <div class="card big"><div class="label">Heart Rate</div><div id="disp_heart_rate" class="value bigv">- bpm</div></div>
          <div class="card big"><div class="label">Kebutuhan Kalori</div><div id="disp_calories" class="value bigv">- kcal</div></div>

          <div class="card"><div class="label">Body Age</div><div id="disp_body_age" class="value">-</div></div>
          <div class="card"><div class="label">Push Up</div><div id="disp_push_up" class="value">- kali</div></div>
          <div class="card"><div class="label">Leg & Back Dynamometer</div><div id="disp_leg_back" class="value">- kg</div></div>
          <div class="card"><div class="label">Handgrip Dynamometer</div><div id="disp_handgrip" class="value">- kg</div></div>
        </div>
      </section>

      <!-- Activity Log -->
      <div class="debug-panel">
        <h3>Activity Log</h3>
        <div class="log-container" id="logContainer"></div>
      </div>

    </main>
  </div>

  <script>
    const API_BASE = 'http://localhost:3000';
    
    let isRunning = false;
    let currentStep = 0;
    
    const sensors = [
      { id: 'name', field: 'name', label: 'Nama', min: null, max: null },
      { id: 'age', field: 'age', label: 'Umur', min: null, max: null },
      { id: 'phone', field: 'phone', label: 'No. Telepon', min: null, max: null },
      { id: 1, label: 'Height (Tinggi Badan)', min: 150, max: 190, unit: 'cm' },
      { id: 2, label: 'Sit & Reach', min: 10, max: 40, unit: 'cm' },
      { id: 3, label: 'Heart Rate', min: 60, max: 100, unit: 'bpm' },
      { id: 4, label: 'Calories (Kebutuhan Kalori)', min: 1500, max: 2500, unit: 'kcal' },
      { id: 5, label: 'Body Age', min: 18, max: 35, unit: '' },
      { id: 6, label: 'Push Up', min: 10, max: 50, unit: 'kali' },
      { id: 7, label: 'Leg & Back Dynamometer', min: 80, max: 150, unit: 'kg' },
      { id: 8, label: 'Handgrip Dynamometer', min: 30, max: 60, unit: 'kg' }
    ];

    function log(message, type = 'info') {
      const logContainer = document.getElementById('logContainer');
      const time = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.innerHTML = `<span class="log-time">[${time}]</span>${message}`;
      logContainer.insertBefore(entry, logContainer.firstChild);
    }

    function updateStatus(status, sensor = '-', value = '-') {
      document.getElementById('sensorStatus').textContent = status;
      document.getElementById('sensorStatus').className = status === 'SCANNING...' ? 'status-value active' : 'status-value idle';
      document.getElementById('currentSensor').textContent = sensor;
      document.getElementById('lastValue').textContent = value;
    }

    function updateProgress(current, total) {
      const percent = (current / total) * 100;
      document.getElementById('progressBar').style.width = percent + '%';
      document.getElementById('progressText').textContent = `${current} / ${total} sensor selesai`;
    }

    async function sendData(sensor, value) {
      try {
        const payload = sensor.field 
          ? { field: sensor.field, value } 
          : { id: sensor.id, value: String(value) };

        const res = await fetch(`${API_BASE}/api/input`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (res.ok) {
          log(`<span class="log-sensor">${sensor.label}</span> ‚Üí <span class="log-value">${value}</span> ‚úÖ Terkirim!`, 'success');
          return true;
        } else {
          log(`‚ùå Gagal kirim ${sensor.label}`, 'error');
          return false;
        }
      } catch (err) {
        log(`‚ùå Error: ${err.message}`, 'error');
        return false;
      }
    }

    async function simulateSensor(sensor) {
      updateStatus('SCANNING...', sensor.label, 'Mengukur...');
      log(`üîç Memulai pengukuran: <span class="log-sensor">${sensor.label}</span>`, 'info');

      // Simulate measurement with delay
      const measurementTime = Math.random() * 2000 + 1500; // 1.5 - 3.5 detik
      
      let value;
      if (sensor.field === 'name') {
        value = document.getElementById('infoName').value || 'John Doe';
      } else if (sensor.field === 'age') {
        value = document.getElementById('infoAge').value || '25';
      } else if (sensor.field === 'phone') {
        value = document.getElementById('infoPhone').value || '08123456789';
      } else {
        // Generate random value in range
        value = Math.floor(Math.random() * (sensor.max - sensor.min + 1)) + sensor.min;
      }

      // Simulate scanning animation with intermediate values
      const steps = 10;
      for (let i = 0; i < steps; i++) {
        if (!isRunning) return false;
        
        const tempValue = sensor.min 
          ? Math.floor(Math.random() * (sensor.max - sensor.min + 1)) + sensor.min
          : value;
        
        updateStatus('SCANNING...', sensor.label, `${tempValue}${sensor.unit || ''}`);
        await new Promise(r => setTimeout(r, measurementTime / steps));
      }

      if (!isRunning) return false;

      // Final value
      updateStatus('COMPLETE', sensor.label, `${value}${sensor.unit || ''}`);
      
      // Send to server
      await sendData(sensor, value);
      
      await new Promise(r => setTimeout(r, 500)); // Pause before next sensor
      
      return true;
    }

    async function startSimulation() {
      if (isRunning) return;
      
      isRunning = true;
      currentStep = 0;
      document.getElementById('startBtn').disabled = true;
      document.getElementById('stopBtn').disabled = false;
      
      log('üöÄ Simulasi dimulai!', 'info');
      updateProgress(0, sensors.length);

      for (let i = 0; i < sensors.length; i++) {
        if (!isRunning) break;
        
        const success = await simulateSensor(sensors[i]);
        if (!success) break;
        
        currentStep++;
        updateProgress(currentStep, sensors.length);
      }

      if (isRunning) {
        log('‚úÖ Semua sensor selesai diukur!', 'success');
        updateStatus('IDLE', '-', '-');
      }
      
      isRunning = false;
      document.getElementById('startBtn').disabled = false;
      document.getElementById('stopBtn').disabled = true;
    }

    function stopSimulation() {
      if (!isRunning) return;
      
      isRunning = false;
      log('‚èπÔ∏è Simulasi dihentikan!', 'error');
      updateStatus('STOPPED', '-', '-');
      document.getElementById('startBtn').disabled = false;
      document.getElementById('stopBtn').disabled = true;
    }

    function resetSimulation() {
      stopSimulation();
      currentStep = 0;
      updateProgress(0, sensors.length);
      updateStatus('IDLE', '-', '-');
      document.getElementById('logContainer').innerHTML = '';
      log('üîÑ Reset selesai!', 'info');
    }

    document.getElementById('startBtn').addEventListener('click', startSimulation);
    document.getElementById('stopBtn').addEventListener('click', stopSimulation);
    document.getElementById('resetBtn').addEventListener('click', resetSimulation);

    log('‚úÖ Debug Sensor Simulator siap digunakan!', 'success');
  </script>
</body>
</html>
